[LearnOpenGL - PBR - IBL - Diffuse irradiance](https://learnopengl.com/PBR/IBL/Diffuse-irradiance)
# Diffuse irradiance
IBL(Image-Based Lighting, 이미지 기반 조명)은 [[../2. Lighting|이전 장]]에서 다룬 직접적인 분석적 광원이 아니라, 주변 환경을 하나의 거대한 광원으로 취급하여 객체를 조명하는 일련의 기술이다. 일반적으로, 실제 환경에서 촬영한 큐브맵 환경 맵을 사용하거나 3D 장면에서 생성한 큐브맵을 변형하여, 이를 조명 방정식에 직접 활용하는 방식으로 이루어진다. 이는 큐브맵의 각 텍셀을 광원으로 간주하는 개념으로, 환경의 전역 조명과 분위기를 효과적으로 포착하여 객체가 해당 환경에 자연스럽게 어우러지는 느낌을 준다.

이미지 기반 조명 알고리즘은 특정 환경의 조명을 캡처하므로, 입력값이 보다 정밀한 형태의 주변광(Ambient Lighting) 역할을 하며, 거친 형태지만 전역 조명(Global Illumination)의 근사치로 볼 수도 있다. 이 점이 PBR(물리 기반 렌더링)에서 중요한 요소가 되는데, 환경의 조명을 반영할 경우 객체가 훨씬 더 물리적으로 정확하게 보이기 때문이다.

PBR 시스템에 IBL을 도입하기 위해, 다시 한번 반사 방정식을 살펴보자:
![[Attachments/Pasted image 20250315132534.png]]
앞서 설명했듯이, 우리의 주된 목표는 반구 Ω 위의 모든 입사광 방향 ωi에 대한 적분을 푸는 것이다. 이전 장에서는 기여하는 특정한 몇 개의 ωi 방향을 사전에 알고 있었기 때문에, 적분을 쉽게 해결할 수 있었다. 하지만 이번에는 주변 환경의 모든 입사광 방향 ωi가 일정량의 복사휘도를 가질 수 있어, 적분을 해결하는 것이 훨씬 더 복잡해진다. 따라서, 적분을 해결하기 위해 두 가지 주요 요구 사항이 필요하다:

1. 주어진 입사광 방향 ωi에서 씬(Scene)의 복사휘도를 가져오는 방법이 필요하다.
2. 적분을 빠르게, 실시간으로 해결해야 한다.

첫 번째 요구 사항은 비교적 쉽다. 앞서 언급했듯이, 환경 또는 씬의 복사 조도를 표현하는 한 가지 방법은 (처리된) 환경 큐브맵을 사용하는 것이다. 이런 큐브맵을 사용하면, 큐브맵의 각 텍셀을 개별적인 발광 광원으로 시각화할 수 있다. 따라서, 특정 방향 벡터 ωi로 이 큐브맵을 샘플링하면 해당 방향에서 씬의 복사휘도를 얻을 수 있다.

따라서, 주어진 방향 벡터 ωi​에서 씬의 복사휘도를 가져오는 과정은 단순히 다음과 같이 수행된다:
```glsl
vec3 radiance = texture(_cubemapEnvironment, w_i).rgb;
```
여전히 적분을 해결하려면 환경 맵을 단일 방향이 아니라 반구 Ω 상의 모든 가능한 방향 ωi​에서 샘플링해야 한다. 하지만 이는 각 프래그먼트 셰이더 호출마다 수행하기에는 너무 비용이 크다. 따라서, 적분을 보다 효율적으로 해결하기 위해 대부분의 연산을 사전 처리 또는 사전 계산할 필요가 있다. 이를 위해 반사 방정식을 좀 더 깊이 살펴보자:
![[Attachments/Pasted image 20250315132831.png]]
반사 방정식을 자세히 살펴보면, BRDF의 난반사(kd) 및 반사광(ks​) 항이 서로 독립적임을 알 수 있으며, 이를 통해 적분을 두 개의 부분으로 나눌 수 있다:
![[Attachments/Pasted image 20250315132900.png]]
적분을 두 부분으로 나누면 난반사 항과 반사광 항을 개별적으로 다룰 수 있으며, 이번 장에서는 난반사 적분에 집중할 것이다.

난반사 적분을 더 자세히 살펴보면, 람버트 난반사 항(kdc/π)은 적분 변수와 관계없이 일정한 상수(색상 c, 굴절률 kd​, π)이므로, 이를 적분 바깥으로 이동할 수 있다:
![[Attachments/Pasted image 20250315132914.png]]
이제 적분이 오직 입사 방향 ωi에만 의존하게 되었으며(단, ppp가 환경 맵의 중심에 위치한다고 가정), 이를 활용하여 사전 계산된 새로운 큐브맵을 생성할 수 있다. 이 큐브맵은 각 샘플 방향(텍셀) ωo​에 대해 난반사 적분 결과를 저장한다.

이를 수행하는 방법이 컨볼루션(Convolution)이다. 컨볼루션은 특정 데이터셋의 각 항목에 대해, 전체 데이터셋을 고려한 연산을 적용하는 방식이다. 여기서 데이터셋은 씬의 복사휘도 또는 환경 맵이다. 따라서, 큐브맵의 각 샘플 방향에 대해 반구 Ω 내의 모든 샘플 방향을 고려하여 적분을 해결한다.

환경 맵을 컨볼루션하기 위해, 각 출력 방향 ωo에 대한 적분을 해결해야 한다. 이를 위해 반구 Ω 내의 다수의 입사 방향 ωi를 이산적으로 샘플링한 후, 해당 방향의 복사휘도를 평균화하는 방식을 사용한다. 이때, 샘플링할 반구는 우리가 컨볼루션하려는 출력 방향 ωo​을 향하도록 정렬된다.
![[Attachments/Pasted image 20250315132922.png]]